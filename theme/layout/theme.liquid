<!doctype html>

<html class="no-js" lang="{{ request.locale.iso_code }}"{%- if request.locale.iso_code == 'ar' or request.locale.iso_code == 'he' -%} dir="rtl"{%- endif -%}>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    
    {% comment %}
    LOGICA PER META ROBOTS PERSONALIZZATO - v2 (corretta per i filtri)
    1. Imposta il default a "index, follow".
    2. Controlla i parametri nell'URL attuale (request.full_path) e il template di ricerca per impostare "noindex, nofollow".
    3. Controlla la paginazione per impostare "noindex, follow".
    4. Stampa il meta tag finale.
{% endcomment %}

{%- assign robots_content = 'index, follow' -%}

{%- if 
    request.full_path contains 'sort_by=' or 
    request.full_path contains 'grid=' or
    request.full_path contains 'type=' or
    request.full_path contains 'filter.p.m.magento.numbottiglie=' or
    request.full_path contains 'filter.v.price.gte=' or
    request.full_path contains 'filter.v.price.lte=' or
    request.full_path contains 'filter.p.m.magento.profondita=' or
    request.full_path contains 'filter.p.m.magento.altezza=' or
    request.full_path contains 'filter.p.m.magento.larghezza=' or
    template.name == 'search'
-%}
{%- assign robots_content = 'noindex, nofollow' -%}

{%- elsif template.name == 'collection' and current_page > 1 -%}
    {%- assign robots_content = 'noindex, follow' -%}
{%- endif -%}

<meta name="robots" content="{{ robots_content }}" />


    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    {%- unless settings.type_heading_font.system? and settings.type_body_font.system? -%}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {%- endunless -%}

    {% render 'meta-tags' %}
    <script src="{{- 'swiper-bundle.min.js' | asset_url -}}" defer="defer"></script>
    <script src="{{- 'bodyScrollLock.min.js' | asset_url -}}" defer="defer"></script>
    <script src="{{- 'pubsub.js' | asset_url -}}" defer="defer"></script>
    <script src="{{- 'global.js' | asset_url -}}" defer="defer"></script>
    <noscript>
      <style>
        img[loading='lazy'] { opacity: 1; }
      </style>
    </noscript>
    <script src="{{ 'cookies.js' | asset_url }}" defer="defer"></script>
    {%- comment -%} Keep navigation inside localhost theme dev preview (no effect on live) {%- endcomment -%}
    <script src="{{ 'z-local-preview-links.js' | asset_url }}" defer="defer"></script>
    {%- comment -%} Sync header search width with centered menu width (desktop) {%- endcomment -%}
    <script src="{{ 'z-header-sync-search-width.js' | asset_url }}" defer="defer"></script>
    {%- comment -%}
      Showine: prevent a brief header search width flicker on navigation.
      Use the last measured menu width immediately (before paint), then the sync script will refine it.
    {%- endcomment -%}
    <script>
      (function () {
        try {
          var v = sessionStorage.getItem('showine_header_menu_width');
          if (v) document.documentElement.style.setProperty('--header-menu-width', v);
        } catch (e) {}
      })();
    </script>
    {%- comment -%} Inject info request form on "lavori eseguiti" subpages when arriving from the index page {%- endcomment -%}
    <script src="{{ 'z-lavori-eseguiti-contact-form.js' | asset_url }}" defer="defer"></script>
    {%- comment -%} Mobile: keep header height variable correct when the menu opens (search row hidden) {%- endcomment -%}
    <script src="{{ 'z-mobile-menu-header-sync.js' | asset_url }}" defer="defer"></script>
    {%- comment -%} Collection subcategories: micro draggable scrollbar under the pills (only when overflowing) {%- endcomment -%}
    <script src="{{ 'z-subcats-scrollbar.js' | asset_url }}" defer="defer"></script>

    {{ content_for_header }}

    {%- render 'settings' -%}

    {{ 'base.css' | asset_url | stylesheet_tag }}
    {{ 'swiper-bundle.min.css' | asset_url | stylesheet_tag }}
    {% render 'css', css: 'component-drawer.css' %}

    {%- if settings.enable_predictive_search -%}
      {% render 'css', css: 'component-predictive-search.css' %}
      <script src="{{- 'predictive-search.js' | asset_url -}}" defer="defer"></script>
    {%- endif -%}

    {% comment %}theme-check-disable AssetPreload{% endcomment %}
    {%- unless settings.type_heading_font.system? -%}
      <link rel="preload" as="font" href="{{ settings.type_heading_font | font_url }}" type="font/woff2" crossorigin>
    {%- endunless -%}
    {%- unless settings.type_body_font.system? -%}
      <link rel="preload" as="font" href="{{ settings.type_body_font | font_url }}" type="font/woff2" crossorigin>
      {%- endunless -%}
    {% comment %}theme-check-enable AssetPreload{% endcomment %}

    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>
    {{ 'z-custom-overrides.css' | asset_url | stylesheet_tag }}
</head>


  <body class="template template--{{ template.name }}{% if template.suffix %} template--{{- template.suffix -}}{% endif %} is-at-top">
    <a class="skip-to-content-link button visually-hidden" href="#MainContent">
      {{- 'theme.accessibility.skip_to_content' | t -}}
    </a>

    {%- sections 'header-group' -%}

    <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>

    <footer class="js-animation-fade-in">
      {%- sections 'footer-group' -%}
    </footer>

    {%- sections 'overlay-group' -%}

    {%- render 'z-whatsapp-floating' -%}

    <ul hidden>
      <li id="a11y-refresh-page-message">{{- 'theme.accessibility.refresh_page' | t -}}</li>
    </ul>

    <script>
      window.theme = window.theme || {};
      theme = {
        settings: {
          money_format: {{ shop.money_format | json }},
          money_with_currency_format: {{ shop.money_with_currency_format | json }},
          cart_free_shipping_threshold: {{ settings.shipping_notification_threshold | times: 100 }},
          cart_free_shipping_text: `{{ 'cart.free_shipping_text_html' | t: amount: '0' }}`,
          cart_free_shipping_text_success: `{{ 'cart.free_shipping_text_success' | t }}`,
        }
      }
      window.shopUrl = '{{ request.origin }}';
      window.routes = {
        cart_url: '{{ routes.cart_url }}',
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        search_url: '{{ routes.search_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}',
      };
      window.cartStrings = {
        error: `{{ 'cart.error' | t }}`,
        quantityError: `{{ 'cart.quantity_error_html' | t: quantity: '[quantity]' }}`
      }
      window.variantStrings = {
        addToCart: '{{ 'theme.actions.add_to_cart' | t }}',
        unavailable: '{{ 'product.unavailable' | t }}',
        soldOut: '{{ 'product.sold_out' | t }}',
        addSubscriptionToCart: 'Add subscription to cart'
      }
      window.validationStrings = {
        invalidEmail: '{{ 'theme.form.invalid_email' | t }}'
      }
      window.accessibilityStrings = {
        recipientFormExpanded: `{{ 'gift_card.recipient.expanded' | t }}`,
        recipientFormCollapsed: `{{ 'gift_card.recipient.collapsed' | t }}`,
      };
    </script>

    {% if settings.back_to_top_button != 'disable' %}
      <back-to-top class="hide">
        <button href="#" class="button back-to-top {{ settings.back_to_top_button }}">
          {% render 'icon', icon_name: 'theme-chevron', class: 'icon--rotate-270' %}
        </button>
      </back-to-top>
    {% endif %}

    {% render 'subify-snippet' %}

    {%- comment -%}
      Disabled: do not force redirects after contact/newsletter submissions.
      Let Shopify show the in-page success message instead.
    {%- endcomment -%}
  
  {%- comment -%}
    Disabled: this script forces the price filter accordion open via a MutationObserver and can cause
    buggy mobile behavior in the facets drawer (range UI appears to reset / flicker).
  {%- endcomment -%}
  {%- comment -%}
  <script src="{{ 'z-open-price-filter.js' | asset_url }}" defer></script>
  {%- endcomment -%}

  {%- comment -%}
    Disabled: this script injects a fallback search in the header and can create a duplicate "mini" search.
    The theme already renders the header search via `snippets/search.liquid`.
  {%- endcomment -%}

    <script>
      function updateMetaRobotsForFilters() {
        const blockedParams = [
          'sort_by=',
          'grid=',
          'type=',          
          'filter.p.m.magento.numbottiglie=',
          'filter.v.price.gte=',
          'filter.v.price.lte=',
          'filter.p.m.magento.profondita=',
          'filter.p.m.magento.altezza=',
          'filter.p.m.magento.larghezza='
        ];
        
        const currentUrl = window.location.href;
        const hasBlockedParams = blockedParams.some(param => currentUrl.includes(param));
        
        let metaRobots = document.querySelector('meta[name="robots"]');

        if (hasBlockedParams) {
          if (!metaRobots) {
            metaRobots = document.createElement('meta');
            metaRobots.setAttribute('name', 'robots');
            document.head.appendChild(metaRobots);
          }
          metaRobots.setAttribute('content', 'noindex, nofollow');
        }
        // Non è necessario un "else" perché il valore di default corretto
        // viene già impostato dal codice Liquid che abbiamo lasciato.
      }

      // Esegui la funzione quando la pagina è pronta
      document.addEventListener('DOMContentLoaded', function() {
        updateMetaRobotsForFilters();

        // Poiché i filtri sono AJAX, dobbiamo osservare le modifiche.
        // Trova il selettore del contenitore principale dei prodotti della collezione.
        // Dovrai probabilmente adattare '#main-collection-product-grid' al selettore corretto del tema.
        // Usa "Ispeziona elemento" del browser per trovarlo. Cerca un ID o una classe come "product-grid", "CollectionProductGrid", etc.
        const productGrid = document.querySelector('#main-collection-product-grid');

        if (productGrid) {
          const observer = new MutationObserver(function(mutations) {
            // Ogni volta che la griglia prodotti cambia, l'URL potrebbe essere cambiato.
            // Eseguiamo di nuovo il nostro controllo.
            updateMetaRobotsForFilters();
          });

          observer.observe(productGrid, { childList: true, subtree: true });
        }
      });
    </script>


</body>
</html>
